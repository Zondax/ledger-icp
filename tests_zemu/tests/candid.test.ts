/**
 *******************************************************************************
 *  (c) 2018 - 2023 Zondax AG
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *******************************************************************************
 */
import InternetComputerApp, { SIGN_VALUES_P2 } from '@zondax/ledger-icp'
import Zemu from '@zondax/zemu'
import { sha256 } from 'js-sha256'
import * as secp256k1 from 'secp256k1'

import { DEFAULT_OPTIONS, DEVICE_MODELS } from './common'

jest.setTimeout(20000)

const path = "m/44'/223'/0'/0/0"
const CANDID_TRANSACTIONS = [
  {
    name: 'sns_add_permissions',
    blob: 'd9d9f7a167636f6e74656e74a66361726759036a4449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20a36e143c86e7e471e7c719506487cf7a6cf40da76361aeafee5133e1d9acea3d010901020a0000000500000001011d29794883d3efb57cc835619ba5961941d7a11ac192735943b2c886e9026b63616e69737465725f69644a000000000000009f01016e696e67726573735f6578706972791b173ce893f99352006b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'sns_remove_permissions',
    blob: 'd9d9f7a167636f6e74656e74a66361726759036a4449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20d7e851652cd032ba5ed76b17f626aa47829f06e5235a0d580e96d3727729ea2401080102050000000100000001011d29794883d3efb57cc835619ba5961941d7a11ac192735943b2c886e9026b63616e69737465725f69644a000000000000001401016e696e67726573735f6578706972791b173ce89843e906c06b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'sns_disburse',
    blob: 'd9d9f7a167636f6e74656e74a66361726759038c4449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20a36e143c86e7e471e7c719506487cf7a6cf40da76361aeafee5133e1d9acea3d010b0101011d841429ba30df507f14f52fbced0b037850b98d89aafaad5b7430f658020120d7e851652cd032ba5ed76b17f626aa47829f06e5235a0d580e96d3727729ea240100c2eb0b000000006b63616e69737465725f69644a000000000000001401016e696e67726573735f6578706972791b173f5f296e3e7a406b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'sns_start_dissolve',
    blob: 'd9d9f7a167636f6e74656e74a6636172675903424449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20d7e851652cd032ba5ed76b17f626aa47829f06e5235a0d580e96d3727729ea24010401026b63616e69737465725f69644a000000000000001401016e696e67726573735f6578706972791b173ce896fceb4f406b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'sns_stop_dissolve',
    blob: 'd9d9f7a167636f6e74656e74a6636172675903424449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20a36e143c86e7e471e7c719506487cf7a6cf40da76361aeafee5133e1d9acea3d010401016b63616e69737465725f69644a000000000000001401016e696e67726573735f6578706972791b173ce896fd46dcc06b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'sns_stake_maturity',
    blob: 'd9d9f7a167636f6e74656e74a6636172675903454449444c3d6d7b6c02ba89e5c20478b9ef938008786c01dbb701006d026c02e28bbf1478c2cee0d80c036e686c01ad86ca8305006e066c02b3b0dac30305ad86ca8305076e086c02a9ddf49b0709a290ead30a796c029cb1fa2505ba89e5c204786c006b029992ccd0010bcebee1d3080c6e0d6c01d7ab010e6c01d0e1e9f60c7e6c018dc3b2b303796c01c88ecad50a786b058cb2f18c0710b09b9ba4070cd0fb87af070c90f29afe0711c3a2f6c90e126e136c01a78882820a146c01dbb701786e166c02ea99cff20475b2b8d4960b176c01c2cee0d80c036c02007801196d1a6c01c2cee0d80c1b6e1c6e786d756c0184f9d1761f6e206e796c04dc87d3aa031e8e8ab6f3081eefca8bdf0d1ea5a389b40f1e6e236c1384aead331df0cefc351ee9f1b4471ed2bbc8ef021ee28b959c03219eb493cf031ed8aa8f8f051e9ebddfd6051e81a6cee6051ece89be97061ec7dae0cc0622feeaf491091e93dfe6aa091e86f998bc091ec182ad960a1ef5cedb9b0b1eaf899aba0d21fde7b1fd0d24c2b0c4aa0f1e6e716c0486fef0ea0a0585f2acb20b05fcc8d7e40e26fbbc93ac0f266b02c2a2dd88070c829aa4b40e276e286c04dbb70178cbe4fdc70471fc91f4f8052681d9b08e0a296c05f8aff58a0175aaeff3c60105b1edd6810407ba89e5c2041eb9ef938008786c029db0f1b80200b3c4b1f204056c04efd6e40226ebbedebd0426cbe4fdc70426fc91f4f805266c02e28bbf14788effd6e90e006c0196bdb4e904716b0ac6c0d51025838db4492ae6d6e4ab0678aedd92a2070c9eb481da0b2bd1a8b0ae0c2c97f7e1c30e0c82a1cfcd0e2d97899f8d0f2ed6f4c7ff0f2f6e306c04efd6e4027198abec810171b6f798b20131a696a48708716c01bbb4b09703226c028d86f0fa0b218c8890fb0b056c02b8c789cb01218c8890fb0b056c01b99d9da50b796c01e0a9b302786e376c02a9ddf49b0709d8a38ca80d386b0cbab5f1a40101918bacf10204948c9eb4030afc9fc683050fc6b3bb9106158db2d5920918e0f8fffd0b328bf3afac0d33cde3c8d30d3490efabef0d3589b8b3b30e36a3f3c0ad0f396e3a6c02ad86ca830500cbe2b58b083b013c20d7e851652cd032ba5ed76b17f626aa47829f06e5235a0d580e96d3727729ea24010701210000006b63616e69737465725f69644a000000000000009f01016e696e67726573735f6578706972791b173f71f879f45e406b6d6574686f645f6e616d656d6d616e6167655f6e6575726f6e6c726571756573745f747970656463616c6c6673656e646572581d19aa3d42c048dd7d14f0cfa0df69a1c1381780f6e9a137abaa6a82e302',
  },
  {
    name: 'icrc_transfer',
    blob: 'd9d9f7a167636f6e74656e74a66361726758be4449444c066d7b6e006c02b3b0dac30368ad86ca8305016e7d6e786c06fbca0102c6fcb60203ba89e5c20401a2de94eb060182f3f3910c04d8a38ca80d7d0105011d841429ba30df507f14f52fbced0b037850b98d89aafaad5b7430f658020120d7e851652cd032ba5ed76b17f626aa47829f06e5235a0d580e96d3727729ea2401b0ea0101080000000000ab41100120a36e143c86e7e471e7c719506487cf7a6cf40da76361aeafee5133e1d9acea3d01000011a4c4149c16c082d43e6b63616e69737465725f69644a000000000000000201016e696e67726573735f6578706972791b173f2e0ad323c0006b6d6574686f645f6e616d656e69637263315f7472616e736665726c726571756573745f747970656463616c6c6673656e646572581d19AA3D42C048DD7D14F0CFA0DF69A1C1381780F6E9A137ABAA6A82E302',
  },
]

describe.each(CANDID_TRANSACTIONS)('CANDID_SNS_ICRC', function (data) {
  test.concurrent.each(DEVICE_MODELS)(`Test: ${data.name}`, async function (m) {
    const sim = new Zemu(m.path)
    try {
      await sim.start({ ...DEFAULT_OPTIONS, model: m.name })
      const app = new InternetComputerApp(sim.getTransport())

      const respAddr = await app.getAddressAndPubKey(path)

      const txBlob = Buffer.from(data.blob, 'hex')

      const respRequest = app.sign(path, txBlob, SIGN_VALUES_P2.DEFAULT)

      // Wait until we are not in the main menu
      await sim.waitUntilScreenIsNot(sim.getMainMenuSnapshot())

      await sim.compareSnapshotsAndApprove('.', `${m.prefix.toLowerCase()}-${data.name}`)

      const signatureResponse = await respRequest
      console.log(signatureResponse)

      expect(signatureResponse.returnCode).toEqual(0x9000)
      expect(signatureResponse.errorMessage).toEqual('No errors')

      // Verify signature
      const hash = sha256.hex(signatureResponse.preSignHash ?? [])

      const hexPubkey = respAddr.publicKey ?? Buffer.alloc(0)
      const pk = Uint8Array.from(hexPubkey)
      expect(pk.byteLength).toEqual(65)

      const digest = Uint8Array.from(Buffer.from(hash, 'hex'))
      const signature = Uint8Array.from(signatureResponse.signatureRS ?? [])
      expect(signature.byteLength).toEqual(64)

      const signatureOk = secp256k1.ecdsaVerify(signature, digest, pk)
      expect(signatureOk).toEqual(true)
    } finally {
      sim.dumpEvents()
      await sim.close()
    }
  })
})
